<div class="mt-5 mb-2">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Personas</h2>
    <div class="d-flex gap-2">
      <!-- Botón Registrar -->
      <p-button 
        (click)="abrirRegistro()" 
        label="Registrar" 
        icon="pi pi-plus" 
        styleClass="p-button-success">
      </p-button>

      <!-- Botón Actualizar -->
      <p-button 
        (click)="actualizarListado()" 
        label="Actualizar" 
        icon="pi pi-refresh" 
        styleClass="p-button-info">
      </p-button>
    </div>
  </div>

  <!-- Tabla Personas -->
  <div class="card">
    <p-table #dt1 [value]="personas" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" 
             [loading]="loading" [paginator]="true" 
             [globalFilterFields]="['id', 'nombres', 'apellidos', 'nroidentidad', 'correo', 'telefono']">

      <ng-template #caption>
        <div class="flex">
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input pInputText #globalFilterInput type="text" 
                   (input)="dt1.filterGlobal(globalFilterInput.value, 'contains')" 
                   placeholder="Buscador.." />
          </p-iconfield>
        </div>
      </ng-template>

      <ng-template #header>
        <tr>
          <th>ID</th>
          <th>Tipo Persona</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Tipo Identidad</th>
          <th>Nro Identidad</th>
          <th>Correo</th>
          <th>Teléfono</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template #body let-persona>
        <tr>
          <td>{{ persona.id }}</td>
          <td>{{ persona.idtipopersona === 1 ? 'Cliente' : 'Administración' }}</td>
          <td>{{ persona.nombres }}</td>
          <td>{{ persona.apellidos }}</td>
          <td>{{ persona.idtipoidentidad === 1 ? 'DNI' : 'RUC' }}</td>
          <td>{{ persona.nroidentidad }}</td>
          <td>{{ persona.correo }}</td>
          <td>{{ persona.telefono }}</td>
          <td>
            <span class="badge bg-{{ persona.idestado === 1 ? 'success' : 'secondary' }}">
              {{ persona.Estado?.nombre}}
            </span>
          </td>
          <td>
            <button pButton type="button" icon="pi pi-pencil" 
                    class="p-button-sm p-button-warning p-mr-2" 
                    (click)="editarPersona(persona)">
              <span class="p-ml-1">Editar</span>
            </button>

            <button pButton type="button" icon="pi pi-trash" 
                    class="p-button-sm p-button-danger" 
                    (click)="eliminarPersona(persona)">
              <span class="p-ml-1">Eliminar</span>
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="10">No se encontraron personas.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Dialog para registrar / editar -->
<p-dialog 
  header="{{editar ? 'Editar Persona' : 'Registrar Persona'}}"
  [(visible)]="mostrarDialogo" 
  [modal]="true" 
  [position]="'top'"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [style]="{width: '40vw'}">

  <div class="p-fluid">
    <form [formGroup]="personaForm">
      
      <div class="mb-3">
        <label for="idtipopersona" class="form-label">Tipo Persona</label>
        <select id="idtipopersona" class="form-select" formControlName="idtipopersona">
          <option [ngValue]="null" disabled selected>Seleccione un tipo de Persona</option>
          <option [ngValue]="1">Cliente</option>
          <option [ngValue]="2">Administración</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="nombres" class="form-label">Nombres</label>
        <input type="text" id="nombres" class="form-control" formControlName="nombres" required>
      </div>

      <div class="mb-3">
        <label for="apellidos" class="form-label">Apellidos</label>
        <input type="text" id="apellidos" class="form-control" formControlName="apellidos">
      </div>

      <div class="mb-3">
  <label for="idtipoidentidad" class="form-label">Tipo Identidad</label>
  <select id="idtipoidentidad" class="form-select" formControlName="idtipoidentidad">
    <option [ngValue]="null" disabled selected>Seleccione un tipo de identidad</option>
    <option [ngValue]="1">DNI</option>
    <option [ngValue]="2">RUC</option>
  </select>
</div>


      <div class="mb-3">
        <label for="nroidentidad" class="form-label">Nro Identidad</label>
        <input type="text" id="nroidentidad" class="form-control" formControlName="nroidentidad">
      </div>

      <div class="mb-3">
        <label for="correo" class="form-label">Correo</label>
        <input type="email" id="correo" class="form-control" formControlName="correo">
      </div>

      <div class="mb-3">
        <label for="telefono" class="form-label">Teléfono</label>
        <input type="text" id="telefono" class="form-control" formControlName="telefono">
      </div>

    </form>

    <div class="d-flex justify-content-end gap-2">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        styleClass="p-button-text" 
        (click)="cerrarDialogo()">
      </p-button>

      <p-button 
        [label]="editar ? 'Guardar Cambios' : 'Guardar'" 
        [icon]="editar ? 'pi pi-save' : 'pi pi-check'" 
        (click)="editar ? guardarEdicion() : guardarPersona()">
      </p-button>
    </div>
  </div>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
