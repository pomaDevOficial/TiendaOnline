<div class="mt-5 mb-2">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h2 class="mb-2 mb-md-0">Gestión de Clientes</h2>
    <div class="d-flex gap-2 flex-wrap">
      <p-button
        (click)="abrirNuevoCliente()"
        label="Nuevo Cliente"
        icon="pi pi-plus"
        styleClass="p-button-success">
      </p-button>
      <p-button
        (click)="cargarClientes()"
        label="Actualizar"
        icon="pi pi-refresh"
        styleClass="p-button-info">
      </p-button>
    </div>
  </div>

  <!-- Tabla Clientes -->
  <div class="card">
    <p-table #dt1 [value]="clientes" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" 
             [loading]="loading" [paginator]="true" 
             [globalFilterFields]="['nombres', 'apellidos', 'nroidentidad', 'correo', 'telefono']">

     <ng-template #caption>
   <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
     <span class="text-muted">Total de clientes: {{clientes.length || 0}}</span>
     <div class="position-relative">
       <i class="pi pi-search position-absolute" style="left: 10px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
       <input pInputText #globalFilterInput type="text"
              (input)="dt1.filterGlobal(globalFilterInput.value, 'contains')"
              placeholder="Buscar clientes..."
              class="p-2 ps-4" style="padding-left: 2.5rem; min-width: 200px;" />
     </div>
   </div>
</ng-template>

      <ng-template #header>
        <tr>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Tipo Doc.</th>
          <th>N° Documento</th>
          <th>Correo</th>
          <th>Teléfono</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template #body let-cliente>
        <tr>
          <td>{{ cliente?.nombres || 'N/A' }}</td>
          <td>{{ cliente?.apellidos || 'N/A' }}</td>
          <td>{{ getTipoIdentidadTexto(cliente?.idtipoidentidad || 1) }}</td>
          <td>{{ cliente?.nroidentidad || 'N/A' }}</td>
          <td>{{ cliente?.correo || 'N/A' }}</td>
          <td>{{ cliente?.telefono || 'N/A' }}</td>
          <td>
            <span class="badge {{ getEstadoBadgeClass(cliente?.idestado || 0) }}">
              {{ cliente.Estado?.nombre}}
            </span>
          </td>
          <td>
            <div class="d-flex gap-1">
              <button pButton type="button" icon="pi pi-pencil" 
                      class="p-button-sm p-button-warning" 
                      (click)="editar(cliente)"
                      pTooltip="Editar" tooltipPosition="top"
                      [disabled]="isClienteEliminado(cliente)">
              </button>

              <button pButton type="button" icon="pi pi-times" 
                      class="p-button-sm p-button-danger" 
                      (click)="eliminarCliente(cliente)"
                      pTooltip="Eliminar" tooltipPosition="top"
                      [disabled]="isClienteEliminado(cliente)">
              </button>

              <button pButton type="button" icon="pi pi-refresh" 
                      class="p-button-sm p-button-secondary" 
                      (click)="restaurarCliente(cliente)"
                      pTooltip="Restaurar" tooltipPosition="top"
                      [disabled]="!isClienteEliminado(cliente)">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="8" class="text-center py-4">
            <i class="pi pi-inbox" style="font-size: 2rem;"></i>
            <p class="text-muted mt-2">No se encontraron clientes</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Dialog para registrar/editar cliente -->
<p-dialog 
  [header]="editarCliente ? 'Editar Cliente' : 'Nuevo Cliente'"
  [(visible)]="mostrarDialogoCliente" 
  [modal]="true" 
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="p-fluid">
    <form [formGroup]="clienteForm">
      
      <div class="mb-3">
        <label for="idtipoidentidad" class="form-label">Tipo de Documento *</label>
        <p-select 
          id="idtipoidentidad" 
          formControlName="idtipoidentidad"
          [options]="tipoIdentidadOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione tipo de documento"
          class="w-100">
        </p-select>
        <small *ngIf="clienteForm.get('idtipoidentidad')?.invalid && clienteForm.get('idtipoidentidad')?.touched" 
               class="text-danger">El tipo de documento es requerido</small>
      </div>

      <div class="mb-3">
        <label for="nroidentidad" class="form-label">N° de Documento *</label>
        <input type="text" id="nroidentidad" class="form-control" formControlName="nroidentidad" 
               [placeholder]="clienteForm.get('idtipoidentidad')?.value === 1 ? '8 dígitos' : '11 dígitos'"
               [maxLength]="clienteForm.get('idtipoidentidad')?.value === 1 ? 8 : 11">
        <small *ngIf="clienteForm.get('nroidentidad')?.invalid && clienteForm.get('nroidentidad')?.touched" 
               class="text-danger">
          {{ clienteForm.get('idtipoidentidad')?.value === 1 ? 'DNI debe tener 8 dígitos' : 'RUC debe tener 11 dígitos' }}
        </small>
      </div>

      <div class="mb-3">
        <label for="nombres" class="form-label">Nombres *</label>
        <input type="text" id="nombres" class="form-control" formControlName="nombres" 
               placeholder="Ingrese los nombres">
        <small *ngIf="clienteForm.get('nombres')?.invalid && clienteForm.get('nombres')?.touched" 
               class="text-danger">Los nombres son requeridos (mínimo 2 caracteres)</small>
      </div>

      <div class="mb-3">
        <label for="apellidos" class="form-label">Apellidos *</label>
        <input type="text" id="apellidos" class="form-control" formControlName="apellidos" 
               placeholder="Ingrese los apellidos">
        <small *ngIf="clienteForm.get('apellidos')?.invalid && clienteForm.get('apellidos')?.touched" 
               class="text-danger">Los apellidos son requeridos (mínimo 2 caracteres)</small>
      </div>

      <div class="mb-3">
        <label for="correo" class="form-label">Correo Electrónico</label>
        <input type="email" id="correo" class="form-control" formControlName="correo" 
               placeholder="ejemplo@correo.com">
        <small *ngIf="clienteForm.get('correo')?.invalid && clienteForm.get('correo')?.touched" 
               class="text-danger">Ingrese un correo electrónico válido</small>
      </div>

      <div class="mb-3">
        <label for="telefono" class="form-label">Teléfono</label>
        <input type="text" id="telefono" class="form-control" formControlName="telefono" 
               placeholder="9XXXXXXXX" maxlength="9">
        <small *ngIf="clienteForm.get('telefono')?.invalid && clienteForm.get('telefono')?.touched" 
               class="text-danger">Ingrese un número de teléfono válido (9 dígitos)</small>
      </div>

      <div class="mb-3">
        <label for="direccion" class="form-label">Dirección</label>
        <textarea id="direccion" class="form-control" formControlName="direccion" 
                  rows="3" placeholder="Ingrese la dirección"></textarea>
      </div>

    </form>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        styleClass="p-button-text" 
        (click)="mostrarDialogoCliente = false">
      </p-button>

      <p-button 
        [label]="editarCliente ? 'Guardar Cambios' : 'Crear Cliente'" 
        [icon]="editarCliente ? 'pi pi-save' : 'pi pi-check'" 
        (click)="editarCliente ? guardarEdicion() : guardarCliente()"
        [disabled]="clienteForm.invalid">
      </p-button>
    </div>
  </div>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>