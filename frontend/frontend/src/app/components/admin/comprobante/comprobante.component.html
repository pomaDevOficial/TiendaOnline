<div class="mt-5 mb-2">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">

    <h2 class="mb-2 mb-md-0">Gestión de Comprobantes</h2>
    <div class="d-flex gap-2 flex-wrap">
      <!-- <button pButton type="button"
              (click)="abrirNuevoComprobante()"
              label="Nuevo Comprobante"
              icon="pi pi-plus"
              class="p-button-success">
      </button> -->
      <!-- Botón de Generar Reporte PDF -->
    <button #pdfButton pButton type="button"
            (click)="generarReportePDF()"
            label="Generar Reporte"
            icon="pi pi-file-pdf"
            class="p-button-danger">
    </button>
      <button pButton type="button"
              (click)="cargarComprobantes()"
              label="Actualizar"
              icon="pi pi-refresh"
              class="p-button-info">
      </button>
    </div>
  </div>

  <!-- Filtros por fecha -->
  <div class="card mb-3">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="card-title mb-0">
          <i class="pi pi-calendar me-2"></i>Filtrar por Fecha
        </h6>
      </div>
      
      <div class="row g-3 align-items-end">
        <div class="col-lg-4 col-md-5">
          <label for="fechaInicio" class="form-label small mb-2">Fecha Inicio</label>
          <p-calendar 
            id="fechaInicio" 
            [(ngModel)]="fechaInicio" 
            dateFormat="dd/mm/yy" 
            [showIcon]="true"
            placeholder="dd/mm/aaaa"
            [style]="{'width': '100%'}">
          </p-calendar>
        </div>
        
        <div class="col-lg-4 col-md-5">
          <label for="fechaFin" class="form-label small mb-2">Fecha Fin</label>
          <p-calendar 
            id="fechaFin" 
            [(ngModel)]="fechaFin" 
            dateFormat="dd/mm/yy" 
            [showIcon]="true"
            placeholder="dd/mm/aaaa"
            [style]="{'width': '100%'}">
          </p-calendar>
        </div>
        
        <div class="col-lg-4 col-md-2 d-flex gap-2 justify-content-lg-start justify-content-md-end">
          <button pButton type="button" 
                  label="Filtrar" 
                  icon="pi pi-filter" 
                  (click)="cargarComprobantesPorFecha()"
                  class="p-button-primary">
          </button>
          <button pButton type="button" 
                  label="Limpiar" 
                  icon="pi pi-times" 
                  (click)="limpiarFiltros()"
                  class="p-button-secondary">
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla Comprobantes con scroll horizontal -->
  <div class="card">
    <div class="table-container">
      <p-table #dt1 [value]="comprobantesFiltrados" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" 
               [loading]="loading" [paginator]="true" 
               [globalFilterFields]="['numserie', 'TipoComprobante.nombre', 'Venta.Pedido.Persona.nombres', 'Venta.Pedido.Persona.apellidos', 'total', 'igv', 'Estado.nombre']"
               [scrollable]="true" scrollHeight="400px"
               (onFilter)="actualizarComprobantesFiltrados($event)">

         <ng-template #caption>
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <span class="text-muted">
        Mostrando: {{comprobantesFiltrados.length || 0}} comprobantes
      </span>
      <div class="p-input-icon-left" style="min-width: 200px;">
        <i class="pi pi-search"></i>
        <input type="text" pInputText
              (input)="dt1.filterGlobal($any($event).target.value, 'contains')"
              placeholder="Buscar comprobantes..." />
      </div>
    </div>
  </ng-template>

        <ng-template #header>
          <tr>
            <th style="min-width: 120px">N° Serie</th>
            <th style="min-width: 120px">Tipo</th>
            <th style="min-width: 200px">Cliente</th>
            <th style="min-width: 150px">Fecha Emisión</th>
            <th style="min-width: 100px">IGV</th>
            <th style="min-width: 120px">Total</th>
            <th style="min-width: 120px">Estado</th>
            <th style="min-width: 250px">Acciones</th>
          </tr>
        </ng-template>

        <ng-template #body let-comprobante>
          <tr>
            <td style="min-width: 120px"><strong>{{ comprobante?.numserie || 'N/A' }}</strong></td>
            <td style="min-width: 120px">{{ comprobante?.TipoComprobante?.nombre || 'N/A' }}</td>
            <td style="min-width: 200px">
              <div *ngIf="comprobante?.Venta?.Pedido?.Persona; else noCliente">
                {{ comprobante.Venta.Pedido.Persona.nombres || 'N/A' }} 
                {{ comprobante.Venta.Pedido.Persona.apellidos || '' }}
              </div>
              <ng-template #noCliente>
                <div>N/A</div>
              </ng-template>
            </td>
            <td style="min-width: 150px">{{ comprobante?.Venta?.fechaventa | date:'dd/MM/yyyy HH:mm' }}</td>
            <td style="min-width: 100px">
              <span class="text-info">S/ {{ comprobante?.igv | number:'1.2-2' }}</span>
            </td>
            <td style="min-width: 120px">
              <span class="fw-bold text-success">S/ {{ comprobante?.total | number:'1.2-2' }}</span>
            </td>
            <td style="min-width: 120px">
              <span class="badge {{ getEstadoBadgeClass(comprobante?.idestado || 0) }}">
                {{ comprobante?.Estado?.nombre || 'N/A' }}
              </span>
            </td>
            <td style="min-width: 250px">
              <div class="flex items-center justify-content-center gap-2">
                <button pButton type="button" icon="pi pi-eye"
                        class="p-button-sm p-button-info"
                        (click)="verDetalle(comprobante)"
                        pTooltip="Ver Detalle" tooltipPosition="top">
                </button>

                <button pButton type="button" icon="pi pi-pencil"
                        class="p-button-sm p-button-warning"
                        (click)="editar(comprobante)"
                        pTooltip="Editar" tooltipPosition="top"
                        [disabled]="comprobante?.idestado === 18">
                </button>

                <button pButton type="button" icon="pi pi-times"
                        class="p-button-sm p-button-danger"
                        (click)="anularComprobante(comprobante)"
                        pTooltip="Anular" tooltipPosition="top"
                        [disabled]="comprobante?.idestado === 18">
                </button>

                <button pButton type="button" icon="pi pi-refresh"
                        class="p-button-sm p-button-secondary"
                        (click)="restaurarComprobante(comprobante)"
                        pTooltip="Restaurar" tooltipPosition="top"
                        [disabled]="comprobante?.idestado === 17">
                </button>

                <button pButton type="button" icon="pi pi-whatsapp"
                        class="p-button-sm p-button-success"
                        (click)="reenviarComprobante(comprobante)"
                        pTooltip="Reenviar por WhatsApp" tooltipPosition="top"
                        [disabled]="comprobante?.idestado === 18">
                </button>
               <button
                pButton
                type="button"
                icon="pi pi-download"
                class="p-button-sm p-button-info"
                (click)="descargarComprobante(comprobante.id)"
                pTooltip="Descargar comprobante"
                tooltipPosition="top">
              </button>

                <!-- <button pButton type="button" icon="pi pi-trash"
                        class="p-button-sm p-button-danger"
                        (click)="eliminarComprobante(comprobante)"
                        pTooltip="Eliminar Permanentemente" tooltipPosition="top">
                </button> -->
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="8" class="text-center py-4">
              <i class="pi pi-inbox" style="font-size: 2rem;"></i>
              <p class="text-muted mt-2">No se encontraron comprobantes</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
<!-- overlay de carga -->
<div class="overlay-loading" *ngIf="loading">
  <p-progressSpinner styleClass="w-4rem h-4rem"></p-progressSpinner>
</div>

<!-- Dialog para registrar/editar comprobante -->
<p-dialog 
  [header]="editarComprobante ? 'Editar Comprobante' : 'Nuevo Comprobante'"
  [(visible)]="mostrarDialogoComprobante" 
  [modal]="true" 
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="p-fluid">
    <form [formGroup]="comprobanteForm">
      
      <div class="mb-3">
        <label for="idventa" class="form-label">Venta *</label>
        <p-select 
          id="idventa" 
          formControlName="idventa" 
          [options]="ventas" 
          optionLabel="id" 
          optionValue="id"
          placeholder="Seleccione una venta"
          class="w-full">
          <ng-template let-venta pTemplate="item">
            <div>Venta #{{ venta.id }} - {{ venta.Pedido?.Persona?.nombres || 'Cliente' }}</div>
          </ng-template>
        </p-select>
        <small *ngIf="comprobanteForm.get('idventa')?.invalid && comprobanteForm.get('idventa')?.touched" 
               class="text-danger">La venta es requerida</small>
      </div>

      <div class="mb-3">
        <label for="idtipocomprobante" class="form-label">Tipo de Comprobante *</label>
        <p-select 
          id="idtipocomprobante" 
          formControlName="idtipocomprobante"
          [options]="tiposComprobante"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Seleccione tipo de comprobante"
          class="w-full">
        </p-select>
        <small *ngIf="comprobanteForm.get('idtipocomprobante')?.invalid && comprobanteForm.get('idtipocomprobante')?.touched" 
               class="text-danger">El tipo de comprobante es requerido</small>
      </div>

      <div class="mb-3">
        <label for="numserie" class="form-label">Número de Serie *</label>
        <input type="text" id="numserie" pInputText formControlName="numserie" 
               placeholder="Ej: B-00000001" class="w-full">
        <small *ngIf="comprobanteForm.get('numserie')?.invalid && comprobanteForm.get('numserie')?.touched" 
               class="text-danger">El número de serie es requerido</small>
      </div>

      <div class="mb-3">
        <label for="igv" class="form-label">IGV *</label>
        <input type="number" id="igv" pInputText formControlName="igv" 
               step="0.01" min="0" placeholder="0.00" class="w-full">
        <small *ngIf="comprobanteForm.get('igv')?.invalid && comprobanteForm.get('igv')?.touched" 
               class="text-danger">El IGV es requerido</small>
      </div>

      <div class="mb-3">
        <label for="descuento" class="form-label">Descuento *</label>
        <input type="number" id="descuento" pInputText formControlName="descuento" 
               step="0.01" min="0" placeholder="0.00" class="w-full">
        <small *ngIf="comprobanteForm.get('descuento')?.invalid && comprobanteForm.get('descuento')?.touched" 
               class="text-danger">El descuento es requerido</small>
      </div>

      <div class="mb-3">
        <label for="total" class="form-label">Total *</label>
        <input type="number" id="total" pInputText formControlName="total" 
               step="0.01" min="0" placeholder="0.00" class="w-full">
        <small *ngIf="comprobanteForm.get('total')?.invalid && comprobanteForm.get('total')?.touched" 
               class="text-danger">El total es requerido</small>
      </div>

    </form>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button pButton type="button" 
              label="Cancelar" 
              icon="pi pi-times" 
              class="p-button-text" 
              (click)="mostrarDialogoComprobante = false">
      </button>

      <button pButton type="button" 
              [label]="editarComprobante ? 'Guardar Cambios' : 'Crear Comprobante'" 
              [icon]="editarComprobante ? 'pi pi-save' : 'pi pi-check'" 
              (click)="guardarComprobante()"
              [disabled]="comprobanteForm.invalid">
      </button>
    </div>
  </div>
</p-dialog>

<!-- Dialog para ver detalle del comprobante -->
<p-dialog 
  [header]="'Detalle del Comprobante ' + (comprobanteSeleccionado?.numserie || '')"
  [(visible)]="mostrarDialogoDetalle" 
  [modal]="true" 
  [style]="{width: '700px'}"
  [draggable]="false"
  [resizable]="false">
  
  <div *ngIf="comprobanteSeleccionado" class="detalle-comprobante">
    <!-- Información principal -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="info-item">
          <strong>N° Serie:</strong> {{ comprobanteSeleccionado.numserie || 'N/A' }}
        </div>
        <div class="info-item">
          <strong>Tipo:</strong> {{ comprobanteSeleccionado.TipoComprobante?.nombre || 'N/A' }}
        </div>
        <div class="info-item">
          <strong>Fecha Emisión:</strong> {{ comprobanteSeleccionado.Venta?.fechaventa | date:'dd/MM/yyyy HH:mm' }}
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-item">
          <strong>Estado:</strong> 
          <span class="badge {{ getEstadoBadgeClass(comprobanteSeleccionado.idestado || 0) }}">
            {{ comprobanteSeleccionado.Estado?.nombre || 'N/A' }}
          </span>
        </div>
        <div class="info-item">
          <strong>IGV:</strong> 
          <span class="text-info">S/ {{ comprobanteSeleccionado.igv | number:'1.2-2' }}</span>
        </div>
        <div class="info-item">
          <strong>Descuento:</strong> 
          <span class="text-warning">S/ {{ comprobanteSeleccionado.descuento | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>
    <!-- Detalle del pedido -->
<div class="row mb-4" *ngIf="pedidoDetalles.length > 0">
  <div class="col-12">
    <h5 class="mb-3">Detalle del Pedido</h5>
    <p-table [value]="pedidoDetalles">
      <ng-template pTemplate="header">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio Unit.</th>
          <th>Subtotal</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-detalle>
        <tr>
          <td>{{ detalle.LoteTalla?.Lote?.Producto?.nombre || 'N/A' }} {{ detalle.LoteTalla?.Talla?.nombre || 'N/A' }} </td>
          <td>{{ detalle.cantidad }}</td>
          <td>S/ {{ detalle.precio | number:'1.2-2' }}</td>
          <td>S/ {{ (detalle.cantidad * detalle.precio) | number:'1.2-2' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

    <!-- Información del cliente -->
    <div class="row mb-4" *ngIf="comprobanteSeleccionado.Venta?.Pedido?.Persona">
      <div class="col-12">
        <h5 class="mb-3">Información del Cliente</h5>
        <div class="info-item">
          <strong>Cliente:</strong> 
          {{ comprobanteSeleccionado.Venta?.Pedido?.Persona?.nombres || 'N/A' }} 
          {{ comprobanteSeleccionado.Venta?.Pedido?.Persona?.apellidos || '' }}
        </div>
        <div class="info-item">
          <strong>Documento:</strong> {{ comprobanteSeleccionado.Venta?.Pedido?.Persona?.nroidentidad || 'N/A' }}
        </div>
        <div class="info-item">
          <strong>Teléfono:</strong> {{ comprobanteSeleccionado.Venta?.Pedido?.Persona?.telefono || 'N/A' }}
        </div>
      </div>
    </div>
    
    <!-- Totales -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="info-item">
          <strong>Subtotal:</strong> 
          <span class="fw-bold">S/ {{ ((comprobanteSeleccionado.total || 0) - (comprobanteSeleccionado.igv || 0)) | number:'1.2-2' }}</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-item">
          <strong>Total:</strong> 
          <span class="text-success fw-bold fs-5">
            S/ {{ comprobanteSeleccionado.total | number:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>
  </div>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>