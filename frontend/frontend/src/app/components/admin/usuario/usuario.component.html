<div class="mt-5 mb-2">
  <!-- Encabezado -->
  <div class="flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Usuarios</h2>
    <div class="flex gap-2">
      <p-button 
        (click)="abrirRegistroUsuario()" 
        label="Registrar Usuario" 
        icon="pi pi-plus" 
        styleClass="p-button-success">
      </p-button>

      <p-button 
        (click)="cargarUsuarios()" 
        label="Actualizar" 
        icon="pi pi-refresh" 
        styleClass="p-button-info">
      </p-button>
    </div>
  </div>

  <!-- Tabla Usuarios -->
  <div class="card shadow-2 border-round">
    <p-table #dt1 [value]="usuarios" dataKey="id" [rows]="10" 
             [rowsPerPageOptions]="[10,25,50]" [loading]="loading" 
             [paginator]="true" 
             [globalFilterFields]="['id','usuario','Persona.nombres','Persona.apellidos','Rol.nombre']">

      <!-- Buscador -->
      <ng-template #caption>
        <div class="flex justify-content-end">
          <p-iconfield iconPosition="left">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input pInputText #globalFilterInput type="text" 
                   (input)="dt1.filterGlobal(globalFilterInput.value, 'contains')" 
                   placeholder="Buscar usuario..." />
          </p-iconfield>
        </div>
      </ng-template>

      <!-- Encabezado -->
      <ng-template #header>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Persona</th>
          <th>Estado</th>
          <th class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <!-- Cuerpo -->
      <ng-template #body let-usuario>
        <tr>
          <td>{{ usuario.id }}</td>
          <td>{{ usuario.usuario }}</td>
          <td>{{ usuario.Rol?.nombre || 'Sin rol' }}</td>
          <td>{{ usuario.Persona?.nombres }} {{ usuario.Persona?.apellidos }}</td>
          <td>
            <span class="badge px-3 py-1 border-round" 
                  [ngClass]="getEstadoBadgeClass(usuario.idestado)">
              {{ usuario.Estado?.nombre }}
            </span>
          </td>
          <td class="text-center">
            <div class="flex justify-content-center gap-2">
              <button pButton type="button" icon="pi pi-pencil" 
                      class="p-button-rounded p-button-warning p-button-sm" 
                      (click)="editarUsuarioData(usuario)"
                      tooltip="Editar usuario" tooltipPosition="top">
              </button>
              
              <!-- Activar -->
              <button pButton type="button" icon="pi pi-check" 
                      class="p-button-rounded p-button-success p-button-sm" 
                      (click)="activarUsuario(usuario.id)"
                      *ngIf="usuario.idestado !== 6"
                      tooltip="Activar usuario" tooltipPosition="top">
              </button>

              <!-- Desactivar -->
              <button pButton type="button" icon="pi pi-times" 
                      class="p-button-rounded p-button-danger p-button-sm" 
                      (click)="desactivarUsuario(usuario.id)"
                      *ngIf="usuario.idestado === 6"
                      tooltip="Desactivar usuario" tooltipPosition="top">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Mensaje vacío -->
      <ng-template #emptymessage>
        <tr>
          <td colspan="6" class="text-center text-500 py-4">No se encontraron usuarios.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- ================== DIALOG USUARIO ================== -->
<p-dialog 
  [header]="editarUsuario ? 'Editar Usuario' : 'Registrar Usuario'"
  [(visible)]="mostrarDialogoUsuario" 
  [modal]="true" 
  [style]="{width: '500px', maxWidth: '90vw'}"
  [draggable]="false"
  [resizable]="false"
  (onHide)="cerrarDialogoUsuario()">

  <form [formGroup]="usuarioForm">
    <div class="dialog-content">

      <!-- Usuario -->
      <div class="form-field">
        <label for="usuario" class="form-label">Usuario *</label>
        <input 
          type="text" 
          id="usuario" 
          pInputText 
          formControlName="usuario"
          class="form-input"
          placeholder="Ingrese el nombre de usuario"
          [class.input-error]="usuarioForm.get('usuario')?.invalid && usuarioForm.get('usuario')?.touched">
        <small class="error-message" *ngIf="usuarioForm.get('usuario')?.invalid && usuarioForm.get('usuario')?.touched">
          Usuario es requerido
        </small>
      </div>

      <!-- Contraseña (solo en creación) -->
      <div class="form-field" *ngIf="!editarUsuario">
        <label for="contrasenia" class="form-label">Contraseña *</label>
        <input 
          type="password" 
          id="contrasenia" 
          pInputText 
          formControlName="contrasenia"
          class="form-input"
          placeholder="Ingrese la contraseña"
          [class.input-error]="usuarioForm.get('contrasenia')?.invalid && usuarioForm.get('contrasenia')?.touched">
        <small class="error-message" *ngIf="usuarioForm.get('contrasenia')?.invalid && usuarioForm.get('contrasenia')?.touched">
          Contraseña es requerida
        </small>
      </div>

      <!-- Rol -->
      <div class="form-field">
        <label for="idrol" class="form-label">Rol *</label>
        <p-dropdown 
          [options]="roles" 
          formControlName="idrol" 
          optionLabel="nombre" 
          optionValue="id"
          placeholder="Seleccione un rol"
          styleClass="form-dropdown"
          [showClear]="true"
          [class.input-error]="usuarioForm.get('idrol')?.invalid && usuarioForm.get('idrol')?.touched">
        </p-dropdown>
        <small class="error-message" *ngIf="usuarioForm.get('idrol')?.invalid && usuarioForm.get('idrol')?.touched">
          Rol es requerido
        </small>
      </div>

      <!-- Persona -->
      <div class="form-field">
        <div class="form-label-container">
          <label for="idpersona" class="form-label">Persona *</label>
          <p-button 
            icon="pi pi-plus" 
            styleClass="p-button-sm p-button-text p-button-info add-person-btn"
            (click)="abrirRegistroPersona()" 
            tooltip="Registrar nueva persona"
            tooltipPosition="top">
          </p-button>
        </div>
        <p-dropdown 
          [options]="personas" 
          formControlName="idpersona" 
          optionLabel="nombres" 
          optionValue="id" 
          placeholder="Seleccione una persona" 
          styleClass="form-dropdown"
          [showClear]="true"
          [class.input-error]="usuarioForm.get('idpersona')?.invalid && usuarioForm.get('idpersona')?.touched">
          <ng-template let-persona pTemplate="item">
            <div class="persona-item">
              <div class="persona-name">{{ persona.nombres }} {{ persona.apellidos }}</div>
              <div class="persona-id">{{ persona.nroidentidad }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        <small class="error-message" *ngIf="usuarioForm.get('idpersona')?.invalid && usuarioForm.get('idpersona')?.touched">
          Persona es requerida
        </small>
      </div>

      <!-- Botones -->
      <div class="dialog-buttons">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          styleClass="p-button-text p-button-secondary" 
          (click)="cerrarDialogoUsuario()">
        </p-button>
        <p-button 
          [label]="editarUsuario ? 'Guardar Cambios' : 'Guardar'" 
          [icon]="editarUsuario ? 'pi pi-save' : 'pi pi-check'" 
          styleClass="p-button-primary"
          (click)="guardarUsuario()">
        </p-button>
      </div>

    </div>
  </form>
</p-dialog>

<!-- ================== DIALOG PERSONA ================== -->
<p-dialog 
  [header]="editarPersona ? 'Editar Persona' : 'Registrar Persona'"
  [(visible)]="mostrarDialogoPersona" 
  [modal]="true" 
  [style]="{width: '600px', maxWidth: '95vw'}"
  [draggable]="false"
  [resizable]="false"
  (onHide)="cerrarDialogoPersona()">

  <form [formGroup]="personaForm">
    <div class="dialog-content">

      <div class="form-row">
        <div class="form-field">
          <label for="idtipopersona" class="form-label">Tipo Persona *</label>
          <p-dropdown 
            [options]="[{label: 'Cliente', value: 1}, {label: 'Administración', value: 2}]" 
            formControlName="idtipopersona" 
            styleClass="form-dropdown"
            placeholder="Seleccione tipo">
          </p-dropdown>
        </div>

        <div class="form-field">
          <label for="idtipoidentidad" class="form-label">Tipo Identidad *</label>
          <p-dropdown 
            [options]="[{label: 'DNI', value: 1}, {label: 'RUC', value: 2}]" 
            formControlName="idtipoidentidad" 
            styleClass="form-dropdown"
            placeholder="Seleccione tipo">
          </p-dropdown>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="nombres" class="form-label">Nombres *</label>
          <input 
            type="text" 
            id="nombres" 
            pInputText 
            formControlName="nombres"
            class="form-input"
            placeholder="Ingrese los nombres">
        </div>
        <div class="form-field">
          <label for="apellidos" class="form-label">Apellidos *</label>
          <input 
            type="text" 
            id="apellidos" 
            pInputText 
            formControlName="apellidos"
            class="form-input"
            placeholder="Ingrese los apellidos">
        </div>
      </div>

      <div class="form-field">
        <label for="nroidentidad" class="form-label">Nro Identidad *</label>
        <input 
          type="text" 
          id="nroidentidad" 
          pInputText 
          formControlName="nroidentidad"
          class="form-input"
          placeholder="Ingrese el número de identidad">
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="correo" class="form-label">Correo</label>
          <input 
            type="email" 
            id="correo" 
            pInputText 
            formControlName="correo"
            class="form-input"
            placeholder="ejemplo@correo.com">
        </div>
        <div class="form-field">
          <label for="telefono" class="form-label">Teléfono</label>
          <input 
            type="text" 
            id="telefono" 
            pInputText 
            formControlName="telefono"
            class="form-input"
            placeholder="Ingrese el teléfono">
        </div>
      </div>

      <div class="dialog-buttons">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          styleClass="p-button-text p-button-secondary" 
          (click)="cerrarDialogoPersona()">
        </p-button>
        <p-button 
          [label]="editarPersona ? 'Guardar Cambios' : 'Guardar'" 
          [icon]="editarPersona ? 'pi pi-save' : 'pi pi-check'" 
          styleClass="p-button-primary"
          (click)="guardarPersona()">
        </p-button>
      </div>

    </div>
  </form>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>