<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="pi pi-shopping-cart me-2"></i>Nueva Venta
          </h2>
          <p class="text-muted mb-0">Seleccione productos con tallas y registre la venta</p>
        </div>
        <div class="d-flex gap-2">
          <p-button
            icon="pi pi-refresh"
            label="Actualizar"
            styleClass="p-button-outlined p-button-secondary"
            (click)="refrescarDatos()">
          </p-button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Panel Principal de Venta -->
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-body">
          <!-- Selección de Cliente -->
          <div class="mb-4">
            <h5 class="card-title mb-3">
              <i class="pi pi-user me-2"></i>Cliente
            </h5>
            <div class="row align-items-end">
              <div class="col-md-8">
                <label class="form-label">Buscar Cliente</label>
                <p-autoComplete
                  [(ngModel)]="clienteSeleccionado"
                  [suggestions]="clientesFiltrados"
                  (completeMethod)="filtrarClientes($event)"
                  field="nombres"
                  placeholder="Buscar por nombre, apellido o email"
                  class="w-100"
                  [style]="{'width': '100%'}">
                  <ng-template let-cliente pTemplate="item">
                    <div class="d-flex align-items-center">
                      <i class="pi pi-user me-2"></i>
                      <div>
                        <div class="fw-bold">{{cliente.nombres}} {{cliente.apellidos}}</div>
                        <small class="text-muted">{{cliente.correo}}</small>
                      </div>
                    </div>
                  </ng-template>
                </p-autoComplete>
              </div>
              <div class="col-md-4">
                <p-button
                  icon="pi pi-plus"
                  label="Registrar Cliente"
                  styleClass="p-button-outlined p-button-primary w-100"
                  (click)="mostrarDialogCliente = true">
                </p-button>
              </div>
            </div>
          </div>

          <p-divider></p-divider>

          <!-- Productos en el Carrito -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">
                <i class="pi pi-shopping-bag me-2"></i>Productos en Carrito
              </h5>
              <div class="d-flex gap-2">
                <p-button
                  icon="pi pi-plus"
                  label="Seleccionar Producto"
                  styleClass="p-button-primary"
                  (click)="abrirDialogProducto()">
                </p-button>
                <p-button
                  *ngIf="cartItems.length > 0"
                  icon="pi pi-trash"
                  label="Vaciar Carrito"
                  styleClass="p-button-danger p-button-outlined"
                  (click)="vaciarCarrito()">
                </p-button>
              </div>
            </div>

            @if (cartItems.length === 0) {
              <div class="text-center py-5">
                <i class="pi pi-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                <h5 class="mt-3 text-muted">Carrito vacío</h5>
                <p class="text-muted">Seleccione productos y tallas para comenzar la venta</p>
              </div>
            } @else {
              <div class="table-responsive">
                <p-table [value]="cartItems" styleClass="p-datatable-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Producto - Talla</th>
                      <th class="text-center">Cantidad</th>
                      <th class="text-end">Precio</th>
                      <th class="text-end">Subtotal</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="ms-2">
                            <div class="fw-bold">{{item.loteTalla.nombre}}</div>
                            <small class="text-muted">Talla: {{item.loteTalla.talla}} | ID: {{item.loteTalla.id}}</small>
                          </div>
                        </div>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">{{item.cantidad}}</span>
                      </td>
                      <td class="text-end">S/ {{item.precio | number:'1.2-2'}}</td>
                      <td class="text-end fw-bold">S/ {{item.subtotal | number:'1.2-2'}}</td>
                      <td class="text-center">
                        <p-button
                          icon="pi pi-trash"
                          styleClass="p-button-danger p-button-text p-button-sm"
                          (click)="eliminarDelCarrito(item)">
                        </p-button>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Lateral - Resumen y Pago -->
    <div class="col-lg-4">
      <!-- Resumen de Venta -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="pi pi-receipt me-2"></i>Resumen de Venta
          </h5>

          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Items totales:</span>
              <span class="fw-bold">{{getTotalItems()}}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Productos distintos:</span>
              <span>{{cartItems.length}}</span>
            </div>
          </div>

          <p-divider></p-divider>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fs-5 fw-bold">Total:</span>
              <span class="fs-5 fw-bold text-primary">S/ {{cartTotal | number:'1.2-2'}}</span>
            </div>
          </div>

          <!-- Método de Pago -->
          <div class="mb-3">
            <label class="form-label">Método de Pago</label>
            <p-dropdown
              [(ngModel)]="metodoPagoSeleccionado"
              [options]="metodosPago"
              optionLabel="nombre"
              placeholder="Seleccionar método"
              class="w-100"
              [style]="{'width': '100%'}"
              [showClear]="true">
            </p-dropdown>
          </div>

          <!-- Botón de Venta -->
          <p-button
            label="Procesar Venta"
            icon="pi pi-check"
            styleClass="p-button-success w-100"
            [loading]="guardandoVenta"
            [disabled]="cartItems.length === 0 || !clienteSeleccionado || !metodoPagoSeleccionado"
            (click)="guardarVenta()">
          </p-button>
        </div>
      </div>

      <!-- Información del Cliente Seleccionado -->
      @if (clienteSeleccionado) {
        <div class="card">
          <div class="card-body">
            <h6 class="card-title mb-3">
              <i class="pi pi-user me-2"></i>Cliente Seleccionado
            </h6>
            <div class="mb-2">
              <strong>{{clienteSeleccionado.nombres}} {{clienteSeleccionado.apellidos}}</strong>
            </div>
            @if (clienteSeleccionado.correo) {
              <div class="mb-2">
                <i class="pi pi-envelope me-2"></i>{{clienteSeleccionado.correo}}
              </div>
            }
            @if (clienteSeleccionado.telefono) {
              <div class="mb-2">
                <i class="pi pi-phone me-2"></i>{{clienteSeleccionado.telefono}}
              </div>
            }
            @if (clienteSeleccionado.nroidentidad) {
              <div class="mb-0">
                <i class="pi pi-id-card me-2"></i>{{clienteSeleccionado.nroidentidad}}
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Diálogo para Agregar Producto -->
<p-dialog
  [(visible)]="mostrarDialogProducto"
  header="Seleccionar Producto y Talla"
  [modal]="true"
  [style]="{'width': '600px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="mb-3">
    <label class="form-label">Producto</label>
    <p-autoComplete
      [(ngModel)]="productoSeleccionado"
      [suggestions]="catalogoFiltrado"
      (completeMethod)="filtrarProductos($event)"
      (onSelect)="onProductoSeleccionado($event)"
      field="nombre"
      placeholder="Buscar producto..."
      class="w-100"
      appendTo="body"
      [style]="{'width': '100%'}">
      <ng-template let-producto pTemplate="item">
        <div class="d-flex align-items-center">
          <div class="ms-2">
            <div class="fw-bold">{{producto.nombre}}</div>
            <small class="text-muted">{{producto.marca.nombre}} - {{producto.categoria.nombre}}</small>
          </div>
        </div>
      </ng-template>
        <!-- Lo que se muestra cuando está seleccionado -->
    <ng-template let-producto pTemplate="selectedItem">
      {{ producto.nombre }} ({{ producto.marca.nombre }})
    </ng-template>
    </p-autoComplete>
  </div>

  @if (tallasDisponibles.length > 0) {
    <div class="mb-3">
      <label class="form-label">Talla Disponible</label>
      <p-dropdown
        [(ngModel)]="tallaSeleccionada"
        [options]="tallasDisponibles"
        optionLabel="talla"
        placeholder="Seleccionar talla"
        class="w-100"
        [style]="{'width': '100%'}">
        <ng-template let-talla pTemplate="item">
          <div class="d-flex justify-content-between align-items-center">
            <span>{{talla.nombre}}</span>
            <div class="text-end">
              <div class="fw-bold">S/ {{talla.preciocosto | number:'1.2-2'}}</div>
              <small class="text-muted">Stock: {{talla.stock}}</small>
            </div>
          </div>
        </ng-template>
      </p-dropdown>
    </div>
  }

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Cantidad</label>
      <p-inputNumber
        [(ngModel)]="cantidadProducto"
        [min]="1"
        [max]="tallaSeleccionada ? tallaSeleccionada.stock : 999"
        class="w-100">
      </p-inputNumber>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">Precio Unitario</label>
      <p-inputNumber
        [ngModel]="tallaSeleccionada?.preciocosto || 0"
        mode="currency"
        currency="PEN"
        locale="es-PE"
        [readonly]="true"
        class="w-100">
      </p-inputNumber>
    </div>
  </div>

  @if (tallaSeleccionada && cantidadProducto > 0) {
    <div class="alert alert-info">
      <div class="d-flex justify-content-between">
        <span><strong>Precio unitario:</strong> S/ {{tallaSeleccionada.preciocosto | number:'1.2-2'}}</span>
        <span><strong>Subtotal:</strong> S/ {{(cantidadProducto * tallaSeleccionada.preciocosto) | number:'1.2-2'}}</span>
      </div>
      <small class="text-muted">Stock disponible: {{tallaSeleccionada.stock}} unidades</small>
    </div>
  }

  <ng-template pTemplate="footer">
    <p-button
      icon="pi pi-times"
      label="Cancelar"
      styleClass="p-button-text"
      (click)="mostrarDialogProducto = false">
    </p-button>
    <p-button
      icon="pi pi-plus"
      label="Agregar al Carrito"
      styleClass="p-button-primary"
      (click)="agregarProductoAlCarrito()"
      [disabled]="!productoSeleccionado || !tallaSeleccionada || cantidadProducto <= 0">
      Agregar {{cantidadProducto}} x {{tallaSeleccionada ? tallaSeleccionada.talla : ''}} al carrito
    </p-button>
  </ng-template>
</p-dialog>

<!-- Diálogo para Nuevo Cliente -->
<p-dialog
  [(visible)]="mostrarDialogCliente"
  header="Registrar Nuevo Cliente"
  [modal]="true"
  [style]="{'width': '600px'}"
  [draggable]="false"
  [resizable]="false">

  <p class="text-muted">Funcionalidad de registro de nuevo cliente próximamente...</p>

  <ng-template pTemplate="footer">
    <p-button
      icon="pi pi-times"
      label="Cerrar"
      styleClass="p-button-text"
      (click)="mostrarDialogCliente = false">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>
