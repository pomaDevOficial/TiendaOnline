<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="pi pi-shopping-cart me-2"></i>Nueva Venta
          </h2>
          <p class="text-muted mb-0">Seleccione productos con tallas y registre la venta</p>
        </div>
        <div class="d-flex gap-2">
          <p-button
            icon="pi pi-refresh"
            label="Actualizar"
            styleClass="p-button-outlined p-button-secondary"
            (click)="refrescarDatos()">
          </p-button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Panel Principal de Venta -->
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-body">
          <!-- Selección de Cliente -->
          <div class="mb-4">
            <h5 class="card-title mb-3">
              <i class="pi pi-user me-2"></i>Cliente
            </h5>
            <div class="row align-items-end">
              <div class="col-md-8">
                <label class="form-label">Buscar Cliente</label>
                <p-autoComplete
                  [(ngModel)]="clienteSeleccionado"
                  [suggestions]="clientesFiltrados"
                  (completeMethod)="filtrarClientes($event)"
                  field="nombres"
                  placeholder="Buscar por nombre, apellido o email"
                  class="w-100"
                  [style]="{'width': '100%'}">
                  <ng-template let-cliente pTemplate="item">
                    <div class="d-flex align-items-center">
                      <i class="pi pi-user me-2"></i>
                      <div>
                        <div class="fw-bold">{{cliente.nombres}} {{cliente.apellidos}}</div>
                        <small class="text-muted">{{cliente.correo}}</small>
                      </div>
                    </div>
                  </ng-template>
                </p-autoComplete>
              </div>
              <div class="col-md-4">
                <p-button
                  icon="pi pi-plus"
                  label="Registrar Cliente"
                  styleClass="p-button-outlined p-button-primary w-100"
                  (click)="mostrarDialogCliente = true">
                </p-button>
              </div>
            </div>
          </div>

          <p-divider></p-divider>

          <!-- Productos en el Carrito -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">
                <i class="pi pi-shopping-bag me-2"></i>Productos en Carrito
              </h5>
              <div class="d-flex gap-2">
                <p-button
                  icon="pi pi-plus"
                  label="Seleccionar Producto"
                  styleClass="p-button-primary"
                  (click)="abrirDialogProducto()">
                </p-button>
                <p-button
                  *ngIf="cartItems.length > 0"
                  icon="pi pi-trash"
                  label="Vaciar Carrito"
                  styleClass="p-button-danger p-button-outlined"
                  (click)="vaciarCarrito()">
                </p-button>
              </div>
            </div>

            @if (cartItems.length === 0) {
              <div class="text-center py-5">
                <i class="pi pi-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                <h5 class="mt-3 text-muted">Carrito vacío</h5>
                <p class="text-muted">Seleccione productos y tallas para comenzar la venta</p>
              </div>
            } @else {
              <div class="table-responsive">
                <p-table [value]="cartItems" styleClass="p-datatable-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Producto - Talla</th>
                      <th class="text-center">Cantidad</th>
                      <th class="text-end">Precio</th>
                      <th class="text-end">Subtotal</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="ms-2">
                            <div class="fw-bold">{{item.LoteTalla.Producto.nombre}} {{item.LoteTalla.Producto.Marca?.nombre}}</div>
                            <small class="text-muted">Talla: {{item.loteTalla.talla}}</small>
                          </div>
                        </div>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">{{item.cantidad}}</span>
                      </td>
                      <td class="text-end">S/ {{item.precio | number:'1.2-2'}}</td>
                      <td class="text-end fw-bold">S/ {{item.subtotal | number:'1.2-2'}}</td>
                      <td class="text-center">
                        <p-button
                          icon="pi pi-trash"
                          styleClass="p-button-danger p-button-text p-button-sm"
                          (click)="eliminarDelCarrito(item)">
                        </p-button>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Lateral - Resumen y Pago -->
    <div class="col-lg-4">
      <!-- Resumen de Venta -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="pi pi-receipt me-2"></i>Resumen de Venta
          </h5>

          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Items totales:</span>
              <span class="fw-bold">{{getTotalItems()}}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Productos distintos:</span>
              <span>{{cartItems.length}}</span>
            </div>
          </div>

          <p-divider></p-divider>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fs-5 fw-bold">Total:</span>
              <span class="fs-5 fw-bold text-primary">S/ {{cartTotal | number:'1.2-2'}}</span>
            </div>
          </div>

          <!-- Método de Pago -->
          <div class="mb-3">
            <label class="form-label">Método de Pago</label>
            <p-dropdown
              [(ngModel)]="metodoPagoSeleccionado"
              [options]="metodosPago"
              optionLabel="nombre"
              placeholder="Seleccionar método"
              class="w-100"
              [style]="{'width': '100%'}"
              [showClear]="true">
            </p-dropdown>
          </div>

          <!-- Botón de Venta -->
          <p-button
            label="Procesar Venta"
            icon="pi pi-check"
            styleClass="p-button-success w-100"
            [loading]="guardandoVenta"
            [disabled]="cartItems.length === 0 || !clienteSeleccionado || !metodoPagoSeleccionado"
            (click)="guardarVenta()">
          </p-button>
        </div>
      </div>

      <!-- Información del Cliente Seleccionado -->
      @if (clienteSeleccionado) {
        <div class="card">
          <div class="card-body">
            <h6 class="card-title mb-3">
              <i class="pi pi-user me-2"></i>Cliente Seleccionado
            </h6>
            <div class="mb-2">
              <strong>{{clienteSeleccionado.nombres}} {{clienteSeleccionado.apellidos}}</strong>
            </div>
            @if (clienteSeleccionado.correo) {
              <div class="mb-2">
                <i class="pi pi-envelope me-2"></i>{{clienteSeleccionado.correo}}
              </div>
            }
            @if (clienteSeleccionado.telefono) {
              <div class="mb-2">
                <i class="pi pi-phone me-2"></i>{{clienteSeleccionado.telefono}}
              </div>
            }
            @if (clienteSeleccionado.nroidentidad) {
              <div class="mb-0">
                <i class="pi pi-id-card me-2"></i>{{clienteSeleccionado.nroidentidad}}
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Diálogo para Agregar Producto - VERSIÓN CORREGIDA -->
<!-- Diálogo para Agregar Producto - VERSIÓN CORREGIDA -->
<p-dialog
  [(visible)]="mostrarDialogProducto"
  header="Buscar Lote y Seleccionar Talla"
  [modal]="true"
  [style]="{'width': '800px'}"
  [draggable]="false"
  [resizable]="false">

  <!-- Búsqueda de Lotes -->
  <div class="mb-4">
    <label class="form-label">Buscar Lote</label>
    <div class="position-relative">
      <p-autoComplete
        [(ngModel)]="loteSeleccionado"
        [suggestions]="lotesFiltrados"
        (completeMethod)="buscarLotes($event)"
        (onSelect)="onLoteSeleccionado($event)"
        optionLabel="displayName"
        placeholder="Escribe para buscar lotes (mínimo 3 caracteres)..."
        [minLength]="3"
        [dropdown]="true"
        class="w-100">
        
        <ng-template let-lote pTemplate="item">
          <div class="d-flex align-items-center p-2">
            <i class="pi pi-tag me-3"></i>
            <div>
              <div class="fw-bold">{{ lote.Producto?.nombre }}</div>
              <small class="text-muted">
                Marca: {{ lote.Producto?.Marca?.nombre || 'N/A' }} | 
                Proveedor: {{ lote.proveedor || 'N/A' }}
              </small>
            </div>
          </div>
        </ng-template>
        
        <ng-template let-lote pTemplate="selectedItem">
          {{ lote.displayName }}
        </ng-template>
      </p-autoComplete>
      
      <!-- Indicador de carga personalizado -->
      @if (cargandoLotes) {
        <div class="position-absolute top-50 end-0 translate-middle-y me-3" style="pointer-events: none;">
          <i class="pi pi-spin pi-spinner text-primary"></i>
        </div>
      }
    </div>
  </div>

  <!-- Mostrar Tallas del Lote Seleccionado en Cards -->
  @if (loteSeleccionado && lotesTalla.length > 0) {
    <div class="mb-3">
      <h6>Tallas Disponibles para {{loteSeleccionado.Producto?.nombre}}</h6>
      <div class="row">
        @for (loteTalla of lotesTalla; track loteTalla.id) {
          <div class="col-md-4 mb-3">
            <p-card class="h-100">
              <ng-template pTemplate="header">
                <div class="text-center py-2 bg-primary text-white rounded-top">
                  <h5 class="mb-0">{{loteTalla.Talla?.nombre}}</h5>
                </div>
              </ng-template>
              
              <div class="text-center">
                <div class="mb-2">
                  <strong>Precio: </strong>S/ {{(loteTalla.precioventa || loteTalla.preciocosto) | number:'1.2-2'}}
                </div>
                <div class="mb-2">
                  <strong>Stock: </strong>
                  <span [class]="(loteTalla.stock ?? 0) > 0 ? 'text-success' : 'text-danger'">
                    {{loteTalla.stock}}
                  </span>
                </div>
                <!-- @if (loteTalla.color) {
                  <div class="mb-2">
                    <strong>Color: </strong>{{loteTalla.color}}
                  </div>
                } -->
              </div>
              
              <ng-template pTemplate="footer">
                <div class="text-center">
                  <p-button 
                    icon="pi pi-plus" 
                    label="Agregar al Carrito"
                    styleClass="p-button-success p-button-sm w-100"
                    (click)="agregarLoteTallaAlCarrito(loteTalla)"
                    [disabled]="(loteTalla.stock ?? 0) <= 0">
                  </p-button>
                </div>
              </ng-template>
            </p-card>
          </div>
        }
      </div>
    </div>
  }

  @if (loteSeleccionado && lotesTalla.length === 0) {
    <div class="alert alert-warning text-center">
      <i class="pi pi-exclamation-triangle me-2"></i>
      No se encontraron tallas disponibles para este lote
    </div>
  }

  <ng-template pTemplate="footer">
    <p-button
      icon="pi pi-times"
      label="Cancelar"
      styleClass="p-button-text"
      (click)="mostrarDialogProducto = false; loteSeleccionado = null; lotesTalla = []">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>
