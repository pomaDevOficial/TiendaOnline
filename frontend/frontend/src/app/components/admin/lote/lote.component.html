<div class="mt-5 mb-2">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Lote</h2>
   <div class="d-flex gap-2">
    <!-- Botón Registrar -->
    <p-button 
      (click)="abrirRegistro()" 
      label="Registrar" 
      icon="pi pi-plus" 
      styleClass="p-button-success">
    </p-button>

    <!-- Botón Actualizar -->
    <p-button 
      (click)="actualizarListado()" 
      label="Actualizar" 
      icon="pi pi-refresh" 
      styleClass="p-button-info">
    </p-button>
  </div>
  </div>
<div class="card">
     <p-table #dt1 [value]="lotes" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [loading]="loading" [paginator]="true" [globalFilterFields]="['id', 'Producto.nombre','proveedor', 'Estado.nombre']">
        <ng-template #caption>
            <div class="flex">
                <p-iconfield iconPosition="left" class="ml-auto">
                    <p-inputicon>
                        <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input pInputText #globalFilterInput type="text" (input)="dt1.filterGlobal(globalFilterInput.value, 'contains')" placeholder="Buscador.." />
                </p-iconfield>
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="min-width:15rem">
                    <div class="flex items-center">
                        ID
                    </div>
                </th>
                <th style="min-width:15rem">
                    <div class="flex items-center">
                        PRODUCTO
                    </div>
                </th>
                <th style="min-width:15rem">
                    <div class="flex items-center">
                        PROVEEDOR
                       
                    </div>
                </th>
                <th style="min-width:15rem">
                    <div class="flex items-center">
                        ESTADO
                       
                    </div>
                </th>
                <th style="min-width:10rem">
                    <div class="flex items-center">
                        ACCIONES
                    </div>
                </th>
                
            </tr>
        </ng-template>
        <ng-template #body let-lote>
            <tr>
                <td>
                    {{ lote.id }}
                </td>
                <td>
                    {{ lote.Producto.nombre }}
                </td>
                <td>
                    {{ lote.proveedor}}
                </td>
                <td>
                    <span class="badge {{ getEstadoBadgeClass(lote.idestado || 0) }}">
                      {{ lote.Estado?.nombre}}
                    </span>
                </td>
                <td>
                  <button pButton 
                          type="button" 
                          icon="pi pi-pencil" 
                          class="p-button-sm p-button-warning p-mr-2" 
                          style="display: inline-flex; align-items: center;" 
                          (click)="editarLote(lote)">
                    <span class="p-ml-1"></span>
                  </button>

                  <!-- Botón Eliminar -->
                  <button pButton 
                          type="button" 
                          icon="pi pi-trash" 
                          class="p-button-sm p-button-danger" 
                          style="display: inline-flex; align-items: center;" 
                          (click)="eliminarLotes(lote)">
                    <span class="p-ml-1"></span>
                  </button>
                </td>
            </tr>
        </ng-template>
        <ng-template #emptymessage>
            <tr>
                <td colspan="7" class="text-center text-500 py-4">No se encontraron registros de lotes.</td>
            </tr>
        </ng-template>
    </p-table>
</div>


</div>
<!-- Dialog para registrar / editar -->
<p-dialog 
  header="{{editar ? 'Editar Lote' : 'Registrar Lote'}}"
  [(visible)]="mostrarDialogo" 
  [modal]="true" 
  [position]="'top'"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [style]="{width: '45vw'}">

  <div class="p-fluid">
    <form [formGroup]="loteForm">
        <div class="mb-3">
          <label class="form-label">Proveedor</label>
        <input type="text" class="form-control" formControlName="proveedor" />
        </div>
           <div class="mb-3">
        <label class="form-label">Producto</label>
        <p-dropdown 
          [options]="productos"
          formControlName="idproducto"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Seleccione un producto"
           [virtualScroll]="false"
            [panelStyle]="{ width: '100%' }" 
                 styleClass="form-dropdown"
          [class.input-error]="loteForm.get('idproducto')?.invalid && loteForm.get('idproducto')?.touched"
          [style]="{ width: '100%' }">
        </p-dropdown>
      </div>
        
      <div class="row">
           <label for="fecha">Fecha:</label>
           <p-calendar 
             id="fecha"
             formControlName="fechaingreso" 
             dateFormat="dd/mm/yy"
             appendTo="body" 
             showIcon="false"
             placeholder="Seleccione una fecha">
           </p-calendar>
           <small *ngIf="loteForm.get('fechaingreso')?.invalid && loteForm.get('fechaingreso')?.touched" class="text-danger">
             La fecha es requerida
           </small>
      </div>
        <!-- <div class="mb-3 d-flex flex-column w-100">
          <label for="nombre" class="form-label">Fecha Ingreso</label>
            <p-datepicker [appendTo]="'body'" [inputStyle]="{ 'width': '100%' }"[(ngModel)]="fecha" [minDate]="minDate" formControlName="fechaingreso" [maxDate]="maxDate" [readonlyInput]="true" />
        </div> -->
        <!-- Botón agregar detalle -->
      <div class="mb-3">
        <p-button 
          label="Agregar detalle" 
          icon="pi pi-plus" 
          styleClass="p-button-sm p-button-outlined"
          (click)="agregarDetalle()">
        </p-button>
      </div>

      <!-- Tabla dinámica de detalles -->
      <div formArrayName="detalles">
        <div *ngFor="let d of detalles.controls; let i = index" [formGroupName]="i" class="mb-2 border rounded p-2">

          <div class="grid">
            <div class="col-3">
              <p-dropdown 
                [options]="tallas" 
                optionLabel="nombre" 
                optionValue="id" 
                 appendTo="body" 
                placeholder="Seleccione Talla"
                formControlName="idtalla"
                 [panelStyle]="{ width: '100%' }" 
                 styleClass="form-dropdown"
                   [virtualScroll]="false">
              </p-dropdown>
            </div>
            <div class="col-3">
               <p-dropdown 
                [options]="listaGeneros" 
                placeholder="Seleccione Género"
                formControlName="esGenero"
                 appendTo="body" 
                 [style]="{ width: '100%' }"
                   [virtualScroll]="false"
                    [panelStyle]="{ width: '100%' }" 
                  styleClass="form-dropdown">
                
              </p-dropdown>
              
            </div>
            <div class="col-3">
              <input type="number" placeholder="Precio" pInputText formControlName="precioventa" class="w-full"/>
            </div>
            <div class="col-2">
              <input type="number" placeholder="Stock" pInputText formControlName="stock" class="w-full"/>
            </div>
            <div class="col-1 flex align-items-center justify-content-center">
              <p-button 
                icon="pi pi-trash" 
                styleClass="p-button-text p-button-danger" 
                (click)="eliminarDetalle(i)">
              </p-button>
            </div>
          </div>

        </div>
      </div>
      </form>


    <div class="d-flex justify-content-end gap-2">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        styleClass="p-button-text" 
        (click)="cerrarDialogo()">
      </p-button>

      <p-button 
        [label]="editar ? 'Guardar Cambios' : 'Guardar'" 
        [icon]="editar ? 'pi pi-save' : 'pi pi-check'" 
        (click)="editar ? guardarEdicion() : guardarLote()">
      </p-button>
    </div>
  </div>
</p-dialog>
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
